<!DOCTYPE html>
<html lang="ko" layout:decorate="~{layout2}">
<head>
    <link rel="stylesheet" type="text/css" th:href="@{/payment.css}">
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
    <meta charset="UTF-8">
    <title>Sample Payment</title>
</head>
<body>
<div layout:fragment="content" style="width : 100%; height : 30%;">
    <div>
        <button id="iamportPayment" onclick="payment()">
        <img src="/imgs/kakaopay.png" style="width : 95px;">
        </button>
        <span>email</span><input class="m_email">
        <span>name</span><input class="s_name">
        <span>phone</span><input class="s_phone">
        <button onclick="cancelPay()">환불하기</button>
    </div>
    <script>
        var today = new Date();
        var hours = today.getHours(); // 시
        var minutes = today.getMinutes();  // 분
        var seconds = today.getSeconds();  // 초
        var milliseconds = today.getMilliseconds();
        var makeMerchantUid = `${hours}` + `${minutes}` + `${seconds}` + `${milliseconds}`;

        $(document).ready(function(){
            $("#iamportPayment").click(function(){
                var m_email = $("input.m_email").val();
                var s_name = $('input.s_name').val();
                var s_phone = $('input.s_phone').val();
                payment(m_email, s_name, s_phone);
            });
        })

       function payment(m_email, s_name, s_phone){
        IMP.init("imp08502572");
        IMP.request_pay({
                pg : 'kakaopay.TC0ONETIME',
                pay_method : 'card',
                merchant_uid: "IMP" + makeMerchantUid,
                name : 'Movie-Boobi Coin Payment',
                amount : 1004,
                buyer_email : 'Iamport@chai.finance',
                buyer_name : '포트원 기술지원팀',
                buyer_tel : '010-1234-5678'
            }, function (rsp) {
            if(rsp.success){
                var msg = '결제가 완료되었습니다.';
                msg += '고유ID : ' + rsp.imp_uid;
                msg += '상점 거래ID : ' + rsp.merchant_uid;
                msg += '결제 금액 : ' + rsp.paid_amount;
                msg += '카드 승인번호 : ' + rsp.apply_num;
                let purchaseVo = {
                    m_email: m_email,
                    s_name: s_name,
                    s_phone: s_phone,
                    o_shipno: rsp.merchant_uid,
                    o_paidAmount: rsp.paid_amount,
                    o_paytype: rsp.pay_method
                }
                $.ajax({
                    url : "placeorder.do",
                    type : "post",
                    data : purchaseVo,
                    dataType : "text",
                    success : function(result){
                    console.log('2');
                    if(result == "y") {
                        alert(msg);
                        location.href = "placeorder.do";
                    }else{
                        alert("디비입력실패");
                        return false;
                    }
                },
                error : function(a,b,c){}
                });
            } else {
               var msg = '결제에 실패하였습니다.';
               msg += '에러내용 : ' + rsp.error_msg;
            }
             alert(msg);
        });
       }

        function cancelPay() {
           jQuery.ajax({
             // 예: http://www.myservice.com/payments/cancel
             "url": "{환불정보를 수신할 가맹점 서비스 URL}",
             "type": "POST",
             "contentType": "application/json",
             "data": JSON.stringify({
               "merchant_uid": "{결제건의 주문번호}", // 예: ORD20180131-0000011
               "cancel_request_amount": 2000,
               "reason": "테스트 결제 환불"
             }),
             "dataType": "json"
           });
        }
    </script>
</div>
</body>
</html>

